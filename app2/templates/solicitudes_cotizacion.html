{% extends 'base.html' %}
{% load static %}

{% block title %}Solicitudes de Cotización{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Solicitudes de Cotización</h1>
  </div>

  <!-- BUSCADOR / FILTROS -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3">

        <div class="col-sm-6 col-md-5">
          <input 
            type="text" 
            name="q" 
            class="form-control"
            placeholder="Buscar por cliente, teléfono o correo..."
            value="{{ request.GET.q|default:'' }}"
          >
        </div>

        <div class="col-sm-4 col-md-3">
          <select name="estado" class="form-select">
            <option value="" {% if not request.GET.estado %}selected{% endif %}>
              Todos los estados
            </option>

            <option value="pendiente" {% if request.GET.estado == 'pendiente' %}selected{% endif %}>
              Pendiente
            </option>

            <option value="procesado" {% if request.GET.estado == 'procesado' %}selected{% endif %}>
              Procesado
            </option>

            {% comment %}
            <option value="finalizado" {% if request.GET.estado == 'finalizado' %}selected{% endif %}>
              Finalizado
            </option>
            {% endcomment %}
          </select>
        </div>

        <div class="col-sm-2 col-md-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search me-1"></i> Buscar
          </button>
          <a href="." class="btn btn-secondary">
            <i class="fas fa-eraser me-1"></i> Limpiar
          </a>
        </div>

      </form>
    </div>
  </div>

  <!-- TABLA DE SOLICITUDES -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Fecha</th>
              {% if SHOW_PRICES %}
              <th>Total Estimado</th>
              {% endif %}
              <th>Estado</th>
              <th style="width:150px;">Acciones</th>
            </tr>
          </thead>

          <tbody>
            {% for s in solicitudes %}
              {% with c=s.cotizacion items=s.items subtotal=s.subtotal %}
              <tr>
                <td><strong>#{{ c.id }}</strong></td>

                <td>
                  <div class="d-flex flex-column">
                    <span class="fw-bold">{{ c.cliente.nombre }}</span>
                    <small class="text-muted">{{ c.cliente.telefono }}</small>
                    <small class="text-muted">{{ c.cliente.correo }}</small>
                  </div>
                </td>

                <td>
                  <i class="far fa-calendar-alt text-muted me-1"></i>
                  {{ c.creado|date:"d M Y" }}
                </td>

                {% if SHOW_PRICES %}
                <td><strong>${{ subtotal|floatformat:2 }}</strong></td>
                {% endif %}

                <td>
                  {% if c.estado|lower == 'pendiente' %}
                    <span class="badge bg-warning text-dark">
                      <i class="fas fa-clock me-1"></i> {{ c.estado|capfirst }}
                    </span>

                  {% elif c.estado|lower == 'finalizado' or c.estado|lower == 'aprobado' %}
                    <span class="badge bg-success">
                      <i class="fas fa-check-circle me-1"></i> {{ c.estado|capfirst }}
                    </span>

                  {% else %}
                    <span class="badge bg-secondary">{{ c.estado|capfirst }}</span>
                  {% endif %}
                </td>

                <td>
                  <button 
                    class="btn btn-sm btn-primary me-1"
                    data-bs-toggle="modal"
                    data-bs-target="#modalDetalle{{ c.id }}"
                    title="Ver detalles"
                  >
                    <i class="fas fa-eye me-1"></i> Ver
                  </button>
                </td>
              </tr>
              {% endwith %}
            {% empty %}
              <tr>
                <td colspan="6" class="text-center py-5">
                  <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
                  <p class="text-muted">No se encontraron solicitudes de cotización</p>
                </td>
              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </div>

</div> 
{% endblock %}

<!-- =========== MODALES =========== -->
{% block modals %}
{% for s in solicitudes %}
  {% with c=s.cotizacion items=s.items subtotal=s.subtotal %}
  <div 
    class="modal fade" 
    id="modalDetalle{{ c.id }}" 
    tabindex="-1" 
    aria-labelledby="modalLabel{{ c.id }}" 
    aria-hidden="true"
  >
    <div class="modal-dialog modal-xl">
      <div class="modal-content">

        <div class="modal-header bg-secondary text-white border-0">
          <h5 class="modal-title" id="modalLabel{{ c.id }}">
            <i class="fas fa-file-alt me-2"></i>
            Detalle Cotización #{{ c.id }}
          </h5>
          <button 
            type="button" 
            class="btn-close btn-close-white" 
            data-bs-dismiss="modal"
          ></button>
        </div>

        <div class="modal-body p-4">
          <div class="row g-4">

            <!-- IZQUIERDA -->
            <div class="col-md-4">
              <div class="card bg-light border-0 h-100">
                <div class="card-body">
                  <h6 class="card-title fw-bold text-primary mb-3">
                    <i class="fas fa-user me-1"></i> Datos del Cliente
                  </h6>

                  <p class="mb-1"><strong>Nombre:</strong> {{ c.cliente.nombre }}</p>
                  <p class="mb-1"><strong>Email:</strong> {{ c.cliente.correo }}</p>
                  <p class="mb-1"><strong>Teléfono:</strong> {{ c.cliente.telefono }}</p>
                  <p class="mb-3"><strong>Fecha:</strong> {{ c.creado }}</p>

                  <hr>

                  <h6 class="card-title fw-bold text-primary mb-2">
                    <i class="fas fa-comment-alt me-1"></i> Mensaje
                  </h6>

                  <div class="p-2 bg-white rounded border">
                    {{ c.mensaje|default:"Sin mensaje adjunto." }}
                  </div>
                </div>
              </div>
            </div>

            <!-- DERECHA -->
            <div class="col-md-8">
              <h6 class="fw-bold mb-3">
                <i class="fas fa-box-open me-1 text-primary"></i> Productos Solicitados
              </h6>

              <div class="table-responsive border rounded">
                <table class="table table-sm table-striped mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Producto</th>
                      <th class="text-center">Cant.</th>
                      <th class="text-end">Precio</th>
                    </tr>
                  </thead>

                  <tbody>
                    {% for it in items %}
                    <tr>
                      <td>{{ it.producto.nombre }}</td>
                      <td class="text-center">{{ it.cantidad }}</td>
                      <td class="text-end">
                        ${% if it.precio_unitario %}
                          {{ it.precio_unitario }}
                        {% else %}
                          {{ it.producto.precio }}
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>

                  <tfoot class="table-light border-top">
                    <tr>
                      <td colspan="2" class="text-end py-3">
                        <strong>Total Estimado:</strong>
                      </td>
                      <td class="text-end py-3">
                        <h5 class="mb-0 text-success">
                          ${{ subtotal|floatformat:2 }}
                        </h5>
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

          </div>

          <!-- TEXTO OCULTO PARA WHATSAPP -->
          <textarea id="texto-ws-{{ c.id }}" style="display:none;">
Saludos cordiales {{ c.cliente.nombre }}, le escribimos desde EDES con respecto a su cotización de:
{% for it in items %}
- {{ it.producto.nombre }} (x{{ it.cantidad }}): ${% if it.precio_unitario %}{{ it.precio_unitario }}{% else %}{{ it.producto.precio }}{% endif %}
{% endfor %}

Total Estimado: ${{ subtotal|floatformat:2 }}
          </textarea>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cerrar
          </button>

          <button 
            type="button" 
            class="btn btn-info text-white"
            onclick="copiarAlPortapapeles('{{ c.id }}', this)"
          >
            <i class="fas fa-copy me-1"></i> Copiar
          </button>

          <a 
            href="{% url 'responder_whatsapp' c.id %}" 
            target="_blank" 
            class="btn btn-success"
            onclick="setTimeout(function(){ location.reload(); }, 1000);"
          >
            <i class="fab fa-whatsapp me-1"></i>
            Responder y Procesar
          </a>
        </div>

      </div>
    </div>
  </div>
  {% endwith %}
{% endfor %}

<script>
  function copiarAlPortapapeles(id, btn) {
    var texto = document.getElementById('texto-ws-' + id).value;

    navigator.clipboard.writeText(texto.trim()).then(function () {
      var originalHTML = btn.innerHTML;
      var originalClass = btn.className;

      btn.innerHTML = '<i class="fas fa-check me-1"></i> Copiado';
      btn.className = 'btn btn-dark text-white';

      setTimeout(function () {
        btn.innerHTML = originalHTML;
        btn.className = originalClass;
      }, 1500);
    }, function (err) {
      console.error('Error al copiar:', err);
      alert('No se pudo copiar el texto');
    });
  }
</script>
{% endblock modals %}
